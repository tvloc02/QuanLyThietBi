<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo cáo tổng hợp - BaoTriStack</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <!-- Custom CSS -->
    <link rel="stylesheet" th:href="@{/css/dashboard.css}">
    <link rel="stylesheet" th:href="@{/css/bao-cao.css}">
    <link rel="stylesheet" href="/css/dashboard.css">
    <link rel="stylesheet" href="/css/bao-cao.css">
</head>
<body>
<div class="main-container">
    <!-- Header Section -->
    <div class="header">
        <div class="header-title">
            <i class="fas fa-chart-line"></i>
            BÁO CÁO TỔNG HỢP HỆ THỐNG
        </div>
        <div class="search-bar">
            <input type="text" placeholder="Tìm kiếm báo cáo..." class="form-control">
        </div>
        <div class="user-info">
            <div class="user-avatar" data-bs-toggle="dropdown" aria-expanded="false">
                <i class="fas fa-user"></i>
            </div>
            <div class="dropdown">
                <div class="account-dropdown dropdown-menu dropdown-menu-end">
                    <div class="account-dropdown-item">
                        <i class="fas fa-user me-2"></i>
                        <span th:text="${hoVaTen ?: 'Admin User'}">Admin User</span>
                    </div>
                    <div class="account-dropdown-item">
                        <i class="fas fa-shield-alt me-2"></i>
                        <span th:text="${roleTitle ?: 'Quản trị viên'}">Quản trị viên</span>
                    </div>
                    <div class="account-dropdown-item">
                        <i class="fas fa-envelope me-2"></i>
                        <span th:text="${email ?: 'admin@truonghoc.edu.vn'}">admin@truonghoc.edu.vn</span>
                    </div>
                    <hr class="my-2">
                    <a href="/tai-khoan/chinh-sua" class="account-dropdown-item">
                        <i class="fas fa-user-edit me-2"></i> Chỉnh sửa hồ sơ
                    </a>
                    <a href="/logout" class="account-dropdown-item text-danger">
                        <i class="fas fa-sign-out-alt me-2"></i> Đăng xuất
                    </a>
                </div>
            </div>
            <div>
                <div style="font-weight: 600; margin-bottom: 4px;" th:text="${hoVaTen ?: 'Admin User'}">Admin User</div>
                <div style="opacity: 0.8; font-size: 0.9rem;" th:text="${roleTitle ?: 'Quản trị viên'}">Quản trị viên</div>
                <div style="opacity: 0.7; font-size: 0.8rem;">
                    <i class="fas fa-clock me-1"></i>
                    <span th:text="${currentTime}">00:56 30/07/2025</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Navigation Menu -->
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container-fluid">
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item dropdown" th:if="${canManageUsers}">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            Người dùng
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/nguoi-dung/nguoi-dung/danh-sach-nguoi-dung">Danh sách người dùng</a></li>
                            <li><a class="dropdown-item" href="/nguoi-dung/duyet-yeu-cau">Duyệt yêu cầu</a></li>
                            <li><a class="dropdown-item" href="/nguoi-dung/them-moi">Thêm người dùng</a></li>
                        </ul>
                    </li>
                    <li class="nav-item" th:if="${canManageDevices}">
                        <a class="nav-link" href="/thiet-bi">Thiết bị</a>
                    </li>
                    <li class="nav-item dropdown" th:if="${canManageMaintenance}">
                        <a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown">
                            Bảo trì
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item" href="/bao-tri/yeu-cau">Yêu cầu bảo trì</a></li>
                            <li><a class="dropdown-item" href="/bao-tri/duyet-yeu-cau">Duyệt yêu cầu</a></li>
                            <li><a class="dropdown-item" href="/bao-tri/ke-hoach">Kế hoạch bảo trì</a></li>
                        </ul>
                    </li>
                    <li class="nav-item dropdown active" th:if="${canViewReports}">
                        <a class="nav-link dropdown-toggle active" href="#" role="button" data-bs-toggle="dropdown">
                            Báo cáo
                        </a>
                        <ul class="dropdown-menu">
                            <li><a class="dropdown-item active" href="/bao-cao/tong-hop">Báo cáo tổng hợp</a></li>
                            <li><a class="dropdown-item" href="/bao-cao/oee">Báo cáo OEE</a></li>
                            <li><a class="dropdown-item" href="/bao-cao/mtbf">Báo cáo MTBF</a></li>
                            <li><a class="dropdown-item" href="/bao-cao/mttr">Báo cáo MTTR</a></li>
                        </ul>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Report Header -->
    <div class="report-header">
        <div class="report-title">
            <i class="fas fa-chart-bar"></i>
            Báo cáo tổng hợp hệ thống
        </div>
        <div class="report-controls">
            <div class="date-range-picker">
                <i class="fas fa-calendar-alt"></i>
                <input type="date" id="fromDate" class="form-control" th:value="${fromDate}">
                <span>đến</span>
                <input type="date" id="toDate" class="form-control" th:value="${toDate}">
                <button class="btn btn-primary" onclick="updateReport()">
                    <i class="fas fa-sync-alt"></i> Cập nhật
                </button>
            </div>
            <div class="report-actions">
                <button class="btn btn-success" onclick="exportReport('excel')">
                    <i class="fas fa-file-excel"></i> Excel
                </button>
                <button class="btn btn-danger" onclick="exportReport('pdf')">
                    <i class="fas fa-file-pdf"></i> PDF
                </button>
                <button class="btn btn-info" onclick="printReport()">
                    <i class="fas fa-print"></i> In
                </button>
            </div>
        </div>
    </div>

    <!-- Summary Cards -->
    <div class="report-summary">
        <div class="row g-4">
            <div class="col-lg-3 col-md-6">
                <div class="summary-card primary">
                    <div class="summary-icon">
                        <i class="fas fa-cogs"></i>
                    </div>
                    <div class="summary-content">
                        <div class="summary-number" th:text="${tongThietBi ?: 0}">0</div>
                        <div class="summary-label">Tổng thiết bị</div>
                        <div class="summary-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span th:text="${(thietBiMoi ?: 0)} + ' mới tháng này'">0 mới tháng này</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="summary-card success">
                    <div class="summary-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="summary-content">
                        <div class="summary-number" th:text="${yeuCauHoanThanh ?: 0}">0</div>
                        <div class="summary-label">Yêu cầu hoàn thành</div>
                        <div class="summary-change positive">
                            <i class="fas fa-arrow-up"></i>
                            <span th:text="${tyLeHoanThanh ?: 0} + '%'">0%</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="summary-card warning">
                    <div class="summary-icon">
                        <i class="fas fa-tools"></i>
                    </div>
                    <div class="summary-content">
                        <div class="summary-number" th:text="${yeuCauDangXuLy ?: 0}">0</div>
                        <div class="summary-label">Đang xử lý</div>
                        <div class="summary-change neutral">
                            <i class="fas fa-minus"></i>
                            <span>Không đổi</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-lg-3 col-md-6">
                <div class="summary-card danger">
                    <div class="summary-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="summary-content">
                        <div class="summary-number" th:text="${canhBaoNghiemTrong ?: 0}">0</div>
                        <div class="summary-label">Cảnh báo nghiêm trọng</div>
                        <div class="summary-change negative">
                            <i class="fas fa-arrow-down"></i>
                            <span>-2 so với tuần trước</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Charts Section -->
    <div class="report-charts">
        <div class="row g-4">
            <!-- Maintenance Trend Chart -->
            <div class="col-lg-8">
                <div class="chart-card">
                    <div class="chart-header">
                        <h5 class="chart-title">Xu hướng bảo trì theo thời gian</h5>
                        <div class="chart-controls">
                            <select class="form-select form-select-sm" id="trendPeriod" onchange="updateTrendChart()">
                                <option value="7">7 ngày qua</option>
                                <option value="30" selected>30 ngày qua</option>
                                <option value="90">3 tháng qua</option>
                                <option value="365">1 năm qua</option>
                            </select>
                        </div>
                    </div>
                    <div class="chart-body">
                        <canvas id="maintenanceTrendChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Status Distribution -->
            <div class="col-lg-4">
                <div class="chart-card">
                    <div class="chart-header">
                        <h5 class="chart-title">Phân bố trạng thái thiết bị</h5>
                    </div>
                    <div class="chart-body">
                        <canvas id="statusDistributionChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Equipment by Category -->
            <div class="col-lg-6">
                <div class="chart-card">
                    <div class="chart-header">
                        <h5 class="chart-title">Thiết bị theo danh mục</h5>
                    </div>
                    <div class="chart-body">
                        <canvas id="equipmentCategoryChart"></canvas>
                    </div>
                </div>
            </div>

            <!-- Maintenance Cost -->
            <div class="col-lg-6">
                <div class="chart-card">
                    <div class="chart-header">
                        <h5 class="chart-title">Chi phí bảo trì theo tháng</h5>
                    </div>
                    <div class="chart-body">
                        <canvas id="maintenanceCostChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Detailed Tables -->
    <div class="report-tables">
        <div class="row g-4">
            <!-- Top Maintenance Requests -->
            <div class="col-lg-6">
                <div class="table-card">
                    <div class="table-header">
                        <h5 class="table-title">Yêu cầu bảo trì gần đây</h5>
                        <a href="/bao-tri/yeu-cau" class="view-all-link">Xem tất cả</a>
                    </div>
                    <div class="table-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                <tr>
                                    <th>Mã yêu cầu</th>
                                    <th>Thiết bị</th>
                                    <th>Trạng thái</th>
                                    <th>Ngày tạo</th>
                                </tr>
                                </thead>
                                <tbody id="recentRequestsTable">
                                <tr>
                                    <td colspan="4" class="text-center">
                                        <div class="loading-spinner">
                                            <i class="fas fa-spinner fa-spin"></i> Đang tải...
                                        </div>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Equipment Status -->
            <div class="col-lg-6">
                <div class="table-card">
                    <div class="table-header">
                        <h5 class="table-title">Thiết bị cần chú ý</h5>
                        <a href="/thiet-bi" class="view-all-link">Xem tất cả</a>
                    </div>
                    <div class="table-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                <tr>
                                    <th>Mã thiết bị</th>
                                    <th>Tên thiết bị</th>
                                    <th>Trạng thái</th>
                                    <th>Hành động</th>
                                </tr>
                                </thead>
                                <tbody id="equipmentStatusTable">
                                <tr>
                                    <td colspan="4" class="text-center">
                                        <div class="loading-spinner">
                                            <i class="fas fa-spinner fa-spin"></i> Đang tải...
                                        </div>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Performance Metrics -->
    <div class="performance-metrics">
        <div class="metrics-card">
            <div class="metrics-header">
                <h5 class="metrics-title">Chỉ số hiệu suất hệ thống</h5>
                <div class="metrics-period">
                    <span>Cập nhật: <span th:text="${lastUpdate}">30/07/2025 14:30</span></span>
                </div>
            </div>
            <div class="metrics-body">
                <div class="row g-4">
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-item">
                            <div class="metric-icon primary">
                                <i class="fas fa-percentage"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-value" th:text="${oeeAverage ?: '85.2'} + '%'">85.2%</div>
                                <div class="metric-label">OEE Trung bình</div>
                                <div class="metric-trend positive">↑ 2.1%</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-item">
                            <div class="metric-icon success">
                                <i class="fas fa-clock"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-value" th:text="${mtbfAverage ?: '320'} + 'h'">320h</div>
                                <div class="metric-label">MTBF Trung bình</div>
                                <div class="metric-trend positive">↑ 15h</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-item">
                            <div class="metric-icon warning">
                                <i class="fas fa-wrench"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-value" th:text="${mttrAverage ?: '4.2'} + 'h'">4.2h</div>
                                <div class="metric-label">MTTR Trung bình</div>
                                <div class="metric-trend negative">↓ 0.3h</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-3 col-md-6">
                        <div class="metric-item">
                            <div class="metric-icon danger">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="metric-content">
                                <div class="metric-value" th:text="${costTotal ?: '125M'} + ' VNĐ'">125M VNĐ</div>
                                <div class="metric-label">Chi phí tháng này</div>
                                <div class="metric-trend neutral">= 0%</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Actions for Reports -->
    <div class="report-actions-section">
        <div class="actions-card">
            <h5 class="actions-title">
                <i class="fas fa-chart-line text-primary me-2"></i>
                Báo cáo khác
            </h5>
            <div class="row g-3">
                <div class="col-md-3 col-sm-6">
                    <a href="/bao-cao/oee" class="action-btn">
                        <div class="action-icon">
                            <i class="fas fa-tachometer-alt"></i>
                        </div>
                        <div>
                            <div class="fw-semibold">Báo cáo OEE</div>
                            <small class="text-muted">Hiệu quả tổng thể thiết bị</small>
                        </div>
                    </a>
                </div>
                <div class="col-md-3 col-sm-6">
                    <a href="/bao-cao/mtbf" class="action-btn">
                        <div class="action-icon">
                            <i class="fas fa-heartbeat"></i>
                        </div>
                        <div>
                            <div class="fw-semibold">Báo cáo MTBF</div>
                            <small class="text-muted">Thời gian giữa các lần hỏng</small>
                        </div>
                    </a>
                </div>
                <div class="col-md-3 col-sm-6">
                    <a href="/bao-cao/mttr" class="action-btn">
                        <div class="action-icon">
                            <i class="fas fa-tools"></i>
                        </div>
                        <div>
                            <div class="fw-semibold">Báo cáo MTTR</div>
                            <small class="text-muted">Thời gian sửa chữa trung bình</small>
                        </div>
                    </a>
                </div>
                <div class="col-md-3 col-sm-6">
                    <a href="/bao-cao/tu-tao" class="action-btn">
                        <div class="action-icon">
                            <i class="fas fa-magic"></i>
                        </div>
                        <div>
                            <div class="fw-semibold">Tự tạo báo cáo</div>
                            <small class="text-muted">Báo cáo tùy chỉnh</small>
                        </div>
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Notification Container -->
<div id="notificationContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 9999;"></div>

<!-- Bootstrap JS -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

<!-- Custom JavaScript -->
<script src="/js/dashboard.js"></script>
<script src="/js/bao-cao.js"></script>
</body>
</html>